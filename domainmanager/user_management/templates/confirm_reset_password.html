{% load static %}
{% block content %}
    {% include 'user_management_header.html' %}
    <main class="main reset-password px-3 container mt-4">
        <div class="row g-0">
          <div class="col col-xl-4 mx-auto">
            <div class="card">
                <div class="card-body p-4 p-lg-5">
                    <img src="{% static 'images/logo_accounts.png' %}" alt="Your project name" class="site-logo img-fluid mb-5" />
                    <h1 class="h2 fw-bold mb-4">Reset your password</h1>
                    <p class="text-midnight mb-4">You've successfully verified your account. Enter new password below:</p>
                    {#TODO: This form doesnt validate#}
                    <form class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="inputNewPass" class="form-label">Password</label>
                            <div class="position-relative">
                            <input
                            type="password"
                            name="new_password"
                            class="form-control"
                            placeholder="Password"
                            id="inputNewPass"
                            required
                            style="padding-right: 3rem;"/>
                            <i class="fa fa-eye togglePassword position-absolute top-50 start-100 translate-middle" id="togglePassword"></i>
                        </div>
                        <div class="invalid-feedback">Password is required.</div>
                        </div>
                        <div id="aggregationNameContainer" class="error-text d-flex align-items-center mt-2 d-none">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-diamond text-danger" viewBox="0 0 16 16">
                            <path d="M6.95.435c.58-.58 1.52-.58 2.1 0l6.515 6.516c.58.58.58 1.519 0 2.098L9.05 15.565c-.58.58-1.519.58-2.098 0L.435 9.05a1.482 1.482 0 0 1 0-2.098L6.95.435zm1.4.7a.495.495 0 0 0-.7 0L1.134 7.65a.495.495 0 0 0 0 .7l6.516 6.516a.495.495 0 0 0 .7 0l6.516-6.516a.495.495 0 0 0 0-.7L8.35 1.134z"></path>
                            <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"></path>
                            </svg>
                            <p class="text-danger my-0 mx-1" id="aggregationNameError"> Error</p>
                        </div>
                        <div class="mb-3">
                            <label for="inputConfirmPass" class="form-label">Confirm Password</label>
                            <div class="position-relative">
                            <input
                            type="password"
                            name="confirm_password"
                            placeholder="Password"
                            class="form-control"
                            id="inputConfirmPass"
                            required
                            style="padding-right: 3rem;"/>
                            <i class="fa fa-eye togglePassword position-absolute top-50 start-100 translate-middle" id="toggleConfirmPassword"></i>
                        </div>
                        <div class="invalid-feedback">Confirm password is required.</div>
                        </div>

                        <div id="aggregationNameContainer" class="error-text d-flex align-items-center mt-2 d-none">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-diamond text-danger" viewBox="0 0 16 16">
                            <path d="M6.95.435c.58-.58 1.52-.58 2.1 0l6.515 6.516c.58.58.58 1.519 0 2.098L9.05 15.565c-.58.58-1.519.58-2.098 0L.435 9.05a1.482 1.482 0 0 1 0-2.098L6.95.435zm1.4.7a.495.495 0 0 0-.7 0L1.134 7.65a.495.495 0 0 0 0 .7l6.516 6.516a.495.495 0 0 0 .7 0l6.516-6.516a.495.495 0 0 0 0-.7L8.35 1.134z"></path>
                            <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"></path>
                            </svg>
                            <p class="text-danger my-0 mx-1" id="aggregationNameError"> Error</p>
                        </div>
                        <button type="submit" class="btn btn-primary d-block w-100 mb-3" id="resetButton" onclick="updatePassword(event)">Reset Password</button>
                    </form>
                    <div class="text-center">
                        <a href="{% url 'user_management:login' %}" class="btn btn-link btn-back text-chambray fw-bolder">Back to Login</a>
                    </div>
                    <div class="alert alert-danger alert-dismissible fade mt-3 p-2 d-none show" id="error_validation" role="alert">
                        <strong id="stng_val_err"></strong>
                    </div>
                </div>
            </div>
          </div>
        </div>
    </main>
    <link rel="stylesheet" type="text/css" href="{% static 'css/styles.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js" integrity="sha512-s+xg36jbIujB2S2VKfpGmlC3T5V2TF3lY48DX7u2r9XzGzgPsa6wTpOQA7J9iffvdeBN0q9tKzRxVxw1JviZPg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        // Example starter JavaScript for disabling form submissions if there are invalid fields
        (function () {
        'use strict'

        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        var forms = document.querySelectorAll('.needs-validation')

        // Loop over them and prevent submission
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
                }

                form.classList.add('was-validated')
            }, false)
            })
        })()
        function updatePassword(event){
            event.preventDefault()
            var url_login = "{% url 'user_management:login' %}";
            if(/^\s+$/.test(event.target.form.new_password.value)){
                console.log("aaaaaaa")
                document.getElementById('stng_val_err').textContent = "Password must not be all white space"
                document.getElementById('error_validation').classList.remove('d-none')
                document.getElementById('error_validation').classList.add('d-block')
            }
            else if(event.target.form.new_password.value != event.target.form.confirm_password.value){
                console.log("bbbbbbb")
                document.getElementById('stng_val_err').textContent = "The password should be similar"
                document.getElementById('error_validation').classList.remove('d-none')
                document.getElementById('error_validation').classList.add('d-block')

            }else if(event.target.form.new_password.value.length < 8){
                console.log("ccccccc")
                document.getElementById('stng_val_err').textContent = "Password length should be greater then 8"
                document.getElementById('error_validation').classList.remove('d-none')
                document.getElementById('error_validation').classList.add('d-block')
            }else{
                console.log("dddddddd")
                var elementb64 = "{{view.kwargs.uidb64|safe}}"
                var elementtoken = "{{view.kwargs.token|safe}}"
                var elementEmail = "{{view.kwargs.email|safe}}"
                $.ajax({
                        method:'POST',
                        url: '/auth' + '/reset/' + elementb64 + "/" + elementtoken + "/" + elementEmail + "/",
                        data:{
                            password:document.getElementById('inputNewPass').value,
                            csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val()
                        },
                        success: function(data) {
                            if(data.status == 200){
                                window.location.href = url_login
                            } else if (!data.hasOwnProperty(status)){
                                document.getElementById('stng_val_err').textContent = "Link has been expired"
                                document.getElementById('error_validation').classList.remove('d-none')
                                document.getElementById('error_validation').classList.add('d-block')
                            }
                            else{
                                document.getElementById('stng_val_err').textContent = data.message
                                document.getElementById('error_validation').classList.remove('d-none')
                                document.getElementById('error_validation').classList.add('d-block')
                            }

                        },
                    });
            }
        }

const togglePassword = document.querySelector('#togglePassword');
const password = document.querySelector('#inputNewPass');

 togglePassword.addEventListener('click', function (e) {
   const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
   password.setAttribute('type', type);
   this.classList.toggle('fa-eye-slash');
});

const toggleConfirmPassword = document.querySelector('#toggleConfirmPassword');
const confirm_password = document.querySelector('#inputConfirmPass');

toggleConfirmPassword.addEventListener('click', function (e) {
   const type = confirm_password.getAttribute('type') === 'password' ? 'text' : 'password';
   confirm_password.setAttribute('type', type);
   this.classList.toggle('fa-eye-slash');
});



    </script>
{% endblock content %}
